Автор: thedenk
Дата: 2021-10-05T14:36:55.000Z
Название: Как мы тестировали и дообучали одну из самых хайповых разработок года
Теги: Блог компании Сбер, Искусственный интеллект
Текст:
Всем привет! Всё началось с того, что мы в Sber AI решили немного
поизучать/почитать подробнее про хайповую нейронную сеть DALL·E и
понять её потенциал возможностей, а также в чём заключается боттлнек –
что же мешает генерить картинки хорошего качества и как можно
попытаться улучшить работу модели?Все автоэнкодеры важны, все
автоэнкодеры нужныО том, что такое автоэнкодеры (AE, VAE, CVAE и др.),
уже много писали на Хабре и не только (можно почитать здесь, здесь и
здесь), так что углубляться не будем. В двух словах: это нейронная
сеть, состоящая из двух частей, – энкодера и декодера. Энкодер сжимает
входной сигнал (например картинку) в какое-то скрытое состояние
меньшей размерности. Декодер переводит скрытое состояние в исходный
сигнал.Таким образом, есть возможность «обучить» свой архиватор. Сами
автоэнкодеры уже существуют давно, ими никого не удивишь. Однако
фантазия исследователей позволяет и по сей день ставить занимательные
эксперименты. Так, например, идея работы DALL·E пришла после создания
так называемого VQ-VAE и последующего его улучшения в VQ-VAE 2, а
потом ещё и в VQ-GAN). Причём тут вообще DALL-E?Краткая вводная для
тех, кто ещё не в курсе. DALL·E – это нейронная сеть, которая создаёт
изображения, основываясь на текстовом описании на естественном языке.
Например, вот что она может создать по тексту «a snail made of harp»
(улитка, сделанная из арфы).Принцип работы DALL·E устроен довольно
просто, его можно сравнить с хорошо известной генерацией текста
«Sequence to Sequence» с помощью Transformer. Для генерации вместо
привычных текстовых токенов используются токены пространства codebook,
которые отображают скрытое дискретное состояние изображений после
процедуры энкодинга VAE. В качестве трансформера используется одна из
версий GPT-3 на 12 миллиардов параметров, а подают в него эмбеддинги
текстового запроса на естественном языке и эмбеддинги codebook
текущего состояния генерации изображения, конкатенированные между
собой. Затем сгенерённая последовательность codebook подаётся в
декодинг VAE, который восстанавливает изображение. Таким образом,
очевидным bottleneck’ом для данной архитектуры является автоэнкодер –
если он не способен восстановить исходное изображение процедурой
encode-decode с приемлемым качеством, то и DALL·E никогда не сможет
сгенерить изображение хорошего качества.Мы решили проверить качество
на различных доменах некоторых опубликованных дискретных VAE и
убедиться, что они действительно справляются со своей задачей. А чем
оригинальный энкодер не угодил?Как уже было сказано выше, есть как
хорошо генерируемые домены, так и плохо генерируемые. Так вот, мы
решили сделать подборку изображений из датасета COCO по некоторым
субъективно выбранным проблемным доменам. Затем с помощью этой
подборки оценили качество на моделях: “16384”: VQGAN ImageNet (f=16),
16384“VAE”: DALL-E dVAE (f=8), 8192, GumbelQuantization“gumbelf8”:
VQGAN OpenImages (f=8), 8192, GumbelQuantization“SBER-gumbelf8”: VQGAN
SberData (f=8), 8192, GumbelQuantizationПоследний из списка мы
дообучали на собственных собранных данных. Стоит отметить, что все
выбранные модели не видели датасет COCO в процессе обучения, и оценка
на этом датасете достаточно честная и независимая. Естественно, для
улучшения качества наши данные были дополнены примерами из этих
доменов. Мы лишь дофайнтюнили предобученные модели из оригинального
репозитория на одну эпоху с warmup learning rate до 1.5e-06.Вы всё ещё
обучаете с нуля? Тогда мы идём к вам!Для оценки качества
восстановленных изображений мы использовали метрики Inception Score
(IS) и Fréchet inception distance (FID), к сожалению, первая статья по
FID куда-то пропала, поэтому предлагаем посмотреть такой вариант.Что
такое IS и как его посчитать, можно почитать тут или тут. Если
вкратце, то для расчёта используется всем известная модель нейронной
сети Inception v3. С помощью неё оценивается вероятность
принадлежности изображений каждому из 1000 классов. Затем все
распределения вероятностей по одинаковым классам суммируются,
считается KL-дивергенция между этими распределениями каждого
индивидуального класса и средним общим распределением. Оценка
принимает значения от 1 до N, где N – количество классов. Чем больше
значения вероятностей принадлежности к каким-то классам и чем больше
разнообразие этих классов, тем больше IS.Похожая ситуация и с FID,
подробное описание и расчёт тут тоже есть. Для FID, однако, уже
необходим датасет, с которым можно сравнить сгенерённые картинки, в
нашем случае это просто набор исходных картинок. Снова используется та
же модель Inception, но уже без головы, и сравниваются распределения
признаков оригинальных и сгенерённых изображений. Чем ближе
распределения, тем больше наши картинки похожи на настоящие.Дообучение
на одну эпоху дало нам следующие результаты, поле all рассчитано как
среднее взвешенное всех категорий на их количество:IS (больше –
лучше):domain/modelVAE16384gumbelf8SBER-gumbelf8Originalall11.13313.64
715.20315.31615.278indoor9.76910.74411.70711.68811.638kitchen9.72611.3
5412.33312.15211.813appliance5.7056.0246.1546.1995.890electronic7.8309
.5099.7129.6069.497furniture10.86113.34614.50014.53114.592outdoor8.163
9.52010.66810.29310.451sports7.4678.5448.8148.8418.962food7.9548.7259.
3909.4349.191vehicle10.52712.94714.24014.55914.233animal11.93314.24915
.99915.87915.857accessory9.39911.68713.11713.38813.228person13.75217.7
9420.04820.42020.600face11.90314.98716.98617.48917.584text14.90218.457
21.39621.29221.131FID (меньше –
лучше):domain/modelVAE16384gumbelf8SBER-gumbelf8all59.75338.91230.3043
0.136indoor74.73457.92545.43244.686kitchen66.42447.08636.73536.579appl
iance80.35970.60453.22552.064electronic77.85664.03450.75950.447furnitu
re53.43838.20429.51029.569outdoor91.93258.87746.30945.287sports65.5403
9.96132.21931.756food76.97453.10941.01841.413vehicle60.31834.25926.721
26.463animal64.25041.52032.03932.078accessory79.84356.31144.66044.454p
erson40.81020.43015.52315.484face54.15334.10926.66326.750text47.29927.
65621.30321.148Также мы посмотрели, как Inception Score оценивает
оригинальные изображения (без процедуры encode-decode). Интересно, что
для данной метрики оригиналы выглядят менее естественными, чем то, что
сгенерили некоторые автоэнкодеры (!). Вероятнее всего, мы уже упёрлись
в возможности данной метрики, оценка с её помощью уже становится менее
объективной. Предлагаем «дедовскими» методами (глазами) посмотреть на
генерации. И вот что получилось с проблемными доменами:  визуально
качество заметно улучшилось для SBER-gumbelf8:«Текст»«Несколько
людей»«Лица»Не моё, а общееМы хотим поделиться с вами тем, что у нас
получилось. А именно – дообученными чекпоинтами и примерами кода,
который поможет вам использовать эти модели. Всё это есть на Google-
диске и в колабе, так что приятного использования!  Колаб с инференсом
моделек.Колаб с расчётом метрик.Общая папка с моделями и
ноутбуками.Ссылка на гитхабНа самом деле очень интересно, какие
примеры у вас получатся. Спасибо, что дочитали до конца, и вперёд, к
новым генерациям!Команда: @denis_karachev, @shonenkov, @dendimitrov
