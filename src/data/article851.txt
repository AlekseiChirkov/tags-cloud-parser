Автор: DSol
Дата: 2021-09-22T12:17:29.000Z
Название: Проблемы использования SPAN для мониторинга в современной сети
Теги: Блог компании НПП «Цифровые решения», Информационная безопасность *,
IT-инфраструктура *, Сетевые технологии *, Сетевое оборудование
Текст:
Ранее мы опубликовывали статью «TAP или SPAN? Рекомендации по
зеркалированию трафика для профессионалов», в которой описаны отличия
подходов по съему трафика и проведен их анализ. Опрос и комментарии
показали, что многие специалисты активно используют SPAN. Данной
статьей мы дополним информацию о SPAN и расскажем, почему ее нельзя
использовать для мониторинга и съема трафика в современной сети.Как
работает SPAN?SPAN – это функция коммутатора или маршрутизатора,
которая позволяет копировать пакеты с указанного порта/портов (порт
зеркалирования) и отправлять на выбранный порт (порт мониторинга).
Порт мониторинга при этом является обычным портом, который
конфигурируется для передачи трафика от зеркалируемого порта/портов.
При этом зеркалировать можно пакеты и на прием, и на передачу или
только в одном направлении.  Для понимания работы функции SPAN
схематично изобразим коммутатор                  (рисунок 1). На схеме
мы оставляем только порты, коммутационную матрицу и буфер
коммутационной матрицы. Как же работает коммутатор? На порт приходит
пакет и поступает на коммутационную матрицу. Матрица сохраняет пакет в
буфер, определяет порт назначения и передаёт в него пакет, освобождая
буфер. Буфер коммутационной матрицы представляет собой память, в
которую помещается пакет, ожидающий своей обработки. Рисунок
1Разберемся, как работает функция SPAN (рисунок 4). Для начала надо
назначить зеркалируемые порты (все пакеты, поступающие с него или на
него, в зависимости от конфигурации, будут копироваться) и порт
мониторинга. Как только коммутационная матрица принимает или
собирается передать пакет через зеркалируемые порты, она дополнительно
передаёт копии пакетов на порт мониторинга. И пока пакет не будет
передан на порт мониторинга, он остаётся в буфере. Стоит отметить,
когда пакет приходит на порт коммутатора/маршрутизатора, он проходит
проверку целостности, а затем может быть модифицирован
(добавление/замена заголовков) или отброшен. В итоге на порт
мониторинга придёт не исходный пакет, а модифицированный. Или вовсе не
придёт.Поведение SPAN при нагрузке Как же будет себя вести коммутатор
при различных нагрузках и вариантах использования порта мониторинга?
Ведь зеркалируемых портов может быть как один, так и десять, а
количество SPAN-портов обычно не превышает 4. Кроме того, меняется
загруженность зеркалируемых портов.  Самой важной характеристикой
порта мониторинга является пропускная способность: если коммутационная
матрица будет подавать на порт мониторинга больше пакетов, чем он
сможет передать, то они будут отбрасываться. На графике (рисунок 2)
показано зеркалирование трафика с одного порта: пропускной способности
порта мониторинга хватает с запасом, чтобы передать все пакеты. Но что
будет, если зеркалировать трафик с нескольких портов? Трафика будет в
разы больше пропускной способности порта мониторинга (рисунок 3).
Пропускной способности порта мониторинга не будет хватать, и часть
пакетов будет отбрасываться.Рисунок 2Рисунок 3Поговорим про реализацию
функции SPAN. Как мы уже упоминали, пока пакет не будет передан и на
целевой порт, и на порт зеркалирования, он занимает место в буфере
пакетов. Зеркалирование нескольких портов (или обоих направлений
передачи одного порта) приводит к скапливанию пакетов в очереди на
порт мониторинга и заполнению буфера. Некоторые производители ставят
самый низкий приоритет для портов мониторинга, иными словами,
оборудование под нагрузкой будет выбирать между передачей трафика на
обычные порты или порты мониторинга. В таком оборудовании ситуация с
превышением зеркалируемого трафика над пропускной способностью порта
мониторинга будет сопровождаться отбрасыванием зеркалируемого трафика
(рисунок 4). Некоторые производители делают отдельно буфер для порта
мониторинга. Он необходим для того, чтобы исключить влияние порта
мониторинга на работоспособность обычных портов. Но этот буфер меньше
основного, и когда он переполняется, происходит такая же потеря
зеркалируемых пакетов. Рисунок 4Влияние функции SPAN на сетьПочему же
производители оборудования ставят низкий приоритет и заранее
закладывают потерю зеркалируемого трафика? Превышение объема
зеркалируемого трафика над полосой пропускания портов мониторинга
приводит к заполнению буфера и отбрасыванию пакетов по обычным портам
(даже если они слабонагружены), ведь пакетный буфер - общий (рисунок
5). Критичный к задержкам трафик (например IP-телефония) при этом
будет потерян. Переповторы остального трафика на транспортном уровне
(преимущественно, это TCP) увеличат нагрузку, вызовут снижение
пропускной способности и приведут к деградации производительности
сети. Переповторы также передаются на порт мониторинга и усложняют
анализ данных. Рисунок 5Более того, даже с пониженным приоритетом все
эти эффекты будут наблюдаться при повышенной нагрузке на коммутатор:
пакетный буфер рассчитан на обычную работу устройства. Если половина
буфера будет занята пакетами, ожидающими отправки на порт мониторинга,
оставшейся половины для полноценный работы устройства уже не
хватит.Потери пакетов при низкой нагрузке на коммутаторДаже в
слабонагруженных сетях трафик передается неравномерно. Сетевые карты
накапливают данные для передачи и затем передают их на скорости порта.
Так называемые всплески трафика (Burst) вызывают эффект локальных по
времени перегрузок портов (рисунок 6). Именно на их сглаживание при
совпадении порта назначения закладываются ресурсы буфера в
коммутаторе. Но даже в устройстве с 10G портами это единицы мегабайт,
а соответственно, единицы миллисекунд превышения пропускной
способности по одному порту. Назначая один из портов портом
мониторинга, мы гарантируем переполнение буфера и потери, как минимум,
зеркалируемых пакетов. Рисунок 6ЗаключениеФункция SPAN была придумана
уже давно для:Выборочного мониторинга портов при поиске неисправностей
и ошибок передачи в сетиОбеспечения информационной безопасности на
слабонагруженных портах, выходящих за границы периметраSPAN –
вспомогательная функция коммутаторов или маршрутизаторов, фактически
работающая в режиме "как есть". При этом в современной сети
зеркалируемых трафик является уже не вспомогательным. Зеркалирование
трафика необходимо для мониторинга внутрисетевой активности и
одновременного подключения средств анализа и информационной
безопасности. В отличие от требований к SPAN-портам, сами порты
зеркалирования за прошедшие десятилетия не изменились (если не считать
возможности туннелирования, никак не решающих проблем потери трафика).
В итоге дорогостоящие системы безопасности просто не получают
полноценных исходных данных для корректной работы, не говоря уже о
предобработке трафика для снижения нагрузки на системы DPI.    Только
зарегистрированные пользователи могут участвовать в опросе. Войдите,
пожалуйста. Сталкивались ли Вы с потерей пакетов при использовании
SPAN?              54.55%            Да              6
27.27%            Нет              3                         18.18%
Использую TAP              2                     Проголосовали 11
пользователей.          Воздержались 4 пользователя.
