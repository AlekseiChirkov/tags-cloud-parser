Автор: gwathedhel
Дата: 2021-09-27T06:43:08.000Z
Название: Делаем IPsec VPN туннель между Cisco FTD и Mikrotik
Теги: IT-инфраструктура *, Cisco *
Текст:
Зачем все этоЭта заметка написана для того, чтобы облегчить путь тем,
кто столкнется с проблемой после меня. Задача кажется тривиальной, но
как обычно, в процессе вылезли проблемы, которые решать пришлось
методом долгого изучения манов и бесконечных перенастроек. В интернете
почему то очень мало информации по настройке Cisco Firepower Threat
Defense (FTD), а тем более - в связке с Mikrotik.Исходные данныеУ нас
есть: Cisco FTD 2120Mikrotik hEX SНесколько маршрутизируемых сетей за
Cisco, одна или несколько локальных сетей за Mikrotik.Необходимость
связать туннелем удаленный офис на Mikrotik с головным офисом за Cisco
FTD.КонфигурацияИзначально нам нужно убедиться, что обе наши стороны
имеют  "белый" маршрутизируемый ip адрес. Теоретически, все это можно
прокинуть через NAT, если устройство находится внутри сети, но это
осложняет конфигурацию, а еще далеко не все провайдеры позволяют one-
to-one NAT в наше время.Начнем со стороны Mikrotik. Предполагаю, что
на нем стоит свежая прошивка (в моем случае это 6.48.4), и он уже
настроен как роутер "белым" адресом наружу.Локальная сеть Mikrotik в
нашем случае: 192.168.88.0/24Сети со стороны Cisco это множество
локальных подсетей:172.16.x.x/24 192.168.x.x/24 10.10.x.x/24
....Маршрутизируемый адрес в примере для Mikrotik
будет:1.2.3.1/32Маршрутизируемый адрес для Cisco:1.2.3.2/32Mikrotik
(Winbox)Начинаем настройку IPsec:IP - IPsec - ProfilesДобавляем
имяHash алгоритмы sha256PRF алгоритмы sha256Алгоритмы шифрования
aes-256Diffie Hellman группа modp2048 (она же группа 14 в другом
наименовании, подробнее есть в мануале у Mikrotik'а)Все остальное
оставляем по умолчанию.Дальше открываем вкладку proposalsЗадаем
имяАлгоритмы аутентификации sha256Алгоритмы шифрования aes-256 cbcPFS
группа modp2048Создаем PeerУказываем имяAddress - это адрес пира, то
есть Cisco (1.2.3.2)Local Address - это адрес самого Mikrotik
(1.2.3.1)Выбираем ранее созданный профильExchange Mode нам нужен
IKE2Переходим на вкладку IdentitiesВыбираем настроенный пир (FTD)Метод
аутентификации pre shared keyВ поле Secret указываем сам ключ
(желательно длинный и сложный. Сохраним его для настройки ответной
стороны)Notrack Chain нужно выбрать preroutingТеперь переходим к
главному - настройке PoliciesОсновная загвоздка в настройке со стороны
Mikrotik - это то, что для одной политики возможно указать только одну
подсеть. Если нам нужно связать 2 подсети, это не проблема. В случае
же с множеством подсетей из разных диапазонов - возникает первая
сложность. Нужно делать политику для каждой подсети.Выбираем созданный
ранее пир (FTD)Выбираем чекбокс TunnelSrc. Address - это подсеть со
стороны Mikrotik, которую мы хотим отправить в туннель
(192.168.88.0/24)Dst.Address - это подсеть, которую мы хотим получить
от FTD (172.16.110.0/24)На второй вкладе (Actions) указываемLevel:
unique - для того, чтобы иметь возможность работы нескольких политик
одновременно.Выбираем proposal из ранее созданного
(FTD_proposal)Повторяем настройки для каждой подсети, которую хотим
добавить в туннель. От каждой локальной, к каждой удаленной.Теперь
нужно настроить Firewall. Начнем с создания адресных листов.IP -
Firewall - Address Lists Указываем имя (для последующих записей нужно
будет выбрать уже существующее имя для добавления в него новой
записи)Указываем подсетьНаша задача: создать 2 листа. Один -
FTD_networks - с сетями, которые мы будем получать. А второй -
Mikrotik_networks - с локальными сетями на Mikrotik.Переходим на
вкладку Filter Rules. Здесь нам нужно создать разрешающие правила для
наших подсетей, чтобы роутер их пропускал.Chain: forwardAdvanced -
Src. Address List: Mikrotik_networksAdvanced - Dst. Address List:
FTD_networksAction: acceptИ второе правило, где Source и Destination
Address List меняются местами. Наши разрешающие правила должны быть
выше запрещающих! Поэтому их нужно перетащить вверх, если это не
так.Переходим на вкладку NAT.Нужно сделать исключения для наших
подсетей, чтобы они не улетали в обычный NAT маскарадинг.Chain:
srcnatAdvanced - Src. Address List: Mikrotik_networksAdvanced - Dst.
Address List: FTD_networksAction: acceptКак и в правилах фильтрации,
нужно сделать 2 правила, поменяв во втором местами Source и
Destination. А так же, поднять эти правила выше правила
masquerade.Переходим на вкладку Raw.Здесь аналогично, нужно сделать 2
правила для прероутингаChain: preroutingAdvanced - Src. Address List:
Mikrotik_networksAdvanced - Dst. Address List: FTD_networksAction:
acceptКак и в предыдущих вкладках, нужно сделать 2 правила, поменяв во
втором местами Source и Destination.На этом настройка со стороны
Mikrotik закончена. Можно приступать к ответной стороне.Cisco FTD
(Firepower Management Center)Логика настройки firewall и NAT со
стороны FTD практически такая же, а вот сам туннель настраивается по-
другому. С него и начнем.Для начала, нам нужно создать группы для
подсетей, которые мы отдаем в туннель и которые получаем.Заходим
Objects - Object Management. Add GroupВ моем случае, для подсетей,
которые мы отдаем это FTD_Subnets. Добавляем в Selected Networks все
подсети, что хотим отдавать в туннель. А получаем мы одну подсеть,
поэтому ее задаем через Add network - Mikrotik_network. Несмотря на
это, лучше задавать группу, даже если внутри будет лишь одна подсеть,
так как в случае расширения - намного проще будет добавить в группу
новую подсеть, чем добавлять новые правила под каждый объект.Переходим
к созданию туннеля. Devices - VPN -Site to Site. Add VPN Firepower
Threat Defense.Указываем имя для нашего подключенияТопология Точка-
ТочкаВерсия IKEv2Во вкладке Endpoints указываем:Node A - это
MikrotikDevice: ExtranetDevice Name: указываем имяIP Address: static,
1.2.3.1Protected Networks: сети, которые мы хотим получать
(Mikrotik_network).Node B - это наша локальная FTDDevice:
FTD2120Interface: выбираем наружный интерфейсIP Address: 1.2.3.2 -
должен подставиться самProtected Networks: сети, которые мы хотим
отдавать (FTD_Subnets).На вкладке IKE заполняем IKEv2 Settings:Policy
- создаем новую:Задаем имяIntegrity Algorythms: SHA256Encryption
Algorythms: AES-256PRF Algorythms: SHA256Diffie-Hellman Group:
14Authentication Type: Pre-shared Manual Key, куда вставляем наш
сохраненный ключНа вкладке IPsec заполняем:Crypto Map Type:
DynamicIKEv2 Mode: TunnelIKEv2 IPsec Proposals: создаем новые:Задаем
имяESP Hash: SHA-256ESP Encryption: AES-256Enable reverse Route
Injection: должна быть включенаСамое важное! Enable Perfect Forward
Secrecy: должна быть включенаModulus Group: 14Без включения этой
функции, на Mikrotik будет активна только одна Policy одновременно. То
есть работать будет только одна подсеть. Все остальные параметры
оставляем по умолчанию. Не забываем сохранить конфигурацию.Теперь нам
нужно (аналогично Mikrotik'у) сделать разрешающие правила и исключения
NAT.Переходим в Policies - Access Control и создаем 2 правилаИз зоны
Inside в Outside, от Mikrotik_network к FTD_Subnets, Allow. Inspection
и Logging можно добавить по вкусу. И второе правило, где все поменяно
местами.В моем случае, зона Inside_Zone - это зона, за которой
находятся все подсети, которые необходимо отправить в
туннель.Outside_Zone - зона интернет. Если есть дополнительные зоны
(DMZ, интерконнекты к другим подсетям) - то нужно сделать правила и
для них. Переходим в Devices - NAT и создаем правило Static, Manual
NAT Rule:Source Interace Objects: Inside_ZoneDestination Interace
Objects: Outside_ZoneOriginal Source: FTD_SubnetsOriginal Destination:
Address - Mikrotik_networkTranslated Source: Address -
FTD_subnetsTranslated Destination: Mikrotik_networkНа вкладке
Advanced: Чекбокс Do not proxy ARP on Destination Interface должен
быть включен.Правило должно быть выше, чем NAT для локальный
подсетей.ПроверкаFTD, к сожалению, показывает не настолько много
информации, как хотелось бы. посмотреть состояние туннеля и возможные
ошибки можно по пути Devices - VPN - Troubleshooting.Со стороны
Mikrotik мы, во-первых, должны увидеть на вкладке IPsec - Active Peers
наше соединение в состоянии establishedа во-вторых, в IPsec - Policies
все политики должны стать A (active) и PH2 State established.Если
политики висят в состоянии no phase 2 все кроме одной - то в первую
очередь смотрим на настройку  Level (unique) в Policies на Mikrotik и
на чекбокс Enable Perfect Forward Secrecy в настройке туннеля на cisco
FTD.UPD: в комментах подсказали, что в DH группе можно выставить
протокол посерьезнее. Например, ecp521 со стороны Mikrotik (group 21
со стороны Cisco) - на скорость передачи данных и загрузку процессора
Mikrotik это практически не влияет (проверил).Так же, Filter Rules на
Mikrotik избыточны, если есть правила по умолчанию (accept in\out
ipsec policy), которые разрешают всё в ipsec и наружу из него.
